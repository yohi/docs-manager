name: ğŸ”— Link Validation & Site Health Check

on:
  push:
    branches: [ main, master ]
    paths:
      - '_documents/**'
      - 'index.md'
      - '_config.yml'
      - '_includes/**'
      - '_layouts/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - '_documents/**'
      - 'index.md'
      - '_config.yml'
      - '_includes/**'
      - '_layouts/**'
  schedule:
    # æ¯æ—¥åˆå‰3æ™‚ï¼ˆJST 12æ™‚ï¼‰ã«å®Ÿè¡Œ
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      deep_scan:
        description: 'Deep scan mode (external links)'
        required: false
        default: 'false'
        type: boolean

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  link-validation:
    name: ğŸ” Link Validation
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ—ï¸ Setup Ruby & Jekyll
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true

    - name: ğŸ“ Create Gemfile if missing
      run: |
        if [ ! -f Gemfile ]; then
          cat > Gemfile << EOF
        source 'https://rubygems.org'
        gem 'jekyll', '~> 4.3'
        gem 'jekyll-feed'
        gem 'jekyll-sitemap'
        gem 'jekyll-seo-tag'
        gem 'jekyll-relative-links'
        gem 'jekyll-optional-front-matter'
        gem 'jekyll-redirect-from'
        gem 'jekyll-default-layout'
        gem 'html-proofer'
        gem 'nokogiri'
        EOF
        fi

    - name: ğŸ”§ Install Dependencies
      run: |
        bundle install

    - name: ğŸ—ï¸ Build Jekyll Site
      run: |
        bundle exec jekyll build --verbose
      env:
        JEKYLL_ENV: production

    - name: ğŸ“Š Jekyll Build Report
      run: |
        echo "## ğŸ—ï¸ Jekyll Build Results" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build Status | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        echo "| Generated Files | $(find _site -type f | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| HTML Files | $(find _site -name "*.html" | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| Total Size | $(du -sh _site | cut -f1) |" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ” Internal Link Validation
      run: |
        echo "ğŸ” Internal link validation starting..."

        # htmlproofer ã§ã®å†…éƒ¨ãƒªãƒ³ã‚¯æ¤œè¨¼
        bundle exec htmlproofer _site \
          --check-html \
          --check-img-http \
          --check-opengraph \
          --report-invalid-tags \
          --report-missing-names \
          --report-script-embeds \
          --report-missing-doctype \
          --report-eof-tags \
          --report-mismatched-tags \
          --ignore-urls "/github.com/,/docs.cursor.com/,/cursor.com/,/discord.gg/" \
          --ignore-status-codes "999,403,429" \
          --swap-urls "^/docs-manager:" \
          --internal-domains "y_ohi.github.io" \
          --log-level :info \
          --typhoeus '{"connecttimeout": 30, "timeout": 60}' || echo "âš ï¸ Some internal link issues found"

    - name: ğŸŒ External Link Validation (Conditional)
      if: github.event.inputs.deep_scan == 'true' || github.event_name == 'schedule'
      run: |
        echo "ğŸŒ External link validation starting..."

        bundle exec htmlproofer _site \
          --external_only \
          --check-external-hash \
          --ignore-urls "/github.com/settings,/discord.gg/,/twitter.com/" \
          --ignore-status-codes "999,403,429,503" \
          --typhoeus '{"connecttimeout": 30, "timeout": 60}' \
          --log-level :info || echo "âš ï¸ Some external link issues found"

    - name: ğŸ“‹ Custom Link Analysis
      run: |
        echo "ğŸ” Custom link analysis..."

        # Markdown ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒªãƒ³ã‚¯åˆ†æ
        echo "## ğŸ“‹ Link Analysis Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # ç›¸å¯¾ãƒ‘ã‚¹ãƒªãƒ³ã‚¯ã®æ¤œå‡º
        RELATIVE_LINKS=$(find _documents -name "*.md" -exec grep -l "\]([^h\{][^)]*)" {} \; 2>/dev/null || true)
        if [ -n "$RELATIVE_LINKS" ]; then
          echo "### âš ï¸ Relative Links Found" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "$RELATIVE_LINKS" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âœ… No Relative Links Found" >> $GITHUB_STEP_SUMMARY
        fi

        # æ¬ ã‘ã¦ã„ã‚‹ .html æ‹¡å¼µå­ã®æ¤œå‡º
        HTML_EXTENSIONS=$(find _documents -name "*.md" -exec grep -l "](.*\.html)" {} \; 2>/dev/null || true)
        if [ -n "$HTML_EXTENSIONS" ]; then
          echo "### âš ï¸ HTML Extensions Found (Should be removed)" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "$HTML_EXTENSIONS" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âœ… No HTML Extensions Found" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸ“Š Site Structure Analysis
      run: |
        echo "ğŸ“Š Site structure analysis..."

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“Š Site Structure" >> $GITHUB_STEP_SUMMARY
        echo "| Directory | Files | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|------|" >> $GITHUB_STEP_SUMMARY

        for dir in _site/documents/_anthropic-prompt-engineering _site/documents/_cursor _site/documents/_claude-code; do
          if [ -d "$dir" ]; then
            DIR_NAME=$(basename "$dir")
            FILE_COUNT=$(find "$dir" -type f | wc -l)
            DIR_SIZE=$(du -sh "$dir" 2>/dev/null | cut -f1 || echo "0K")
            echo "| $DIR_NAME | $FILE_COUNT | $DIR_SIZE |" >> $GITHUB_STEP_SUMMARY
          fi
        done

    - name: ğŸš¨ Missing Index Pages Detection
      run: |
        echo "ğŸš¨ Missing index pages detection..."

        MISSING_INDEXES=""

        # ä¸»è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®index.mdã‚’ãƒã‚§ãƒƒã‚¯
        for dir in _documents/_anthropic-prompt-engineering _documents/_cursor _documents/_claude-code; do
          if [ -d "$dir" ] && [ ! -f "$dir/index.md" ]; then
            MISSING_INDEXES="$MISSING_INDEXES\n- $dir/index.md"
          fi
        done

        # ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®index.mdã‚’ãƒã‚§ãƒƒã‚¯
        find _documents -type d -name "_*" | while read subdir; do
          if [ ! -f "$subdir/index.md" ]; then
            MISSING_INDEXES="$MISSING_INDEXES\n- $subdir/index.md"
          fi
        done

        if [ -n "$MISSING_INDEXES" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš¨ Missing Index Pages" >> $GITHUB_STEP_SUMMARY
          echo -e "$MISSING_INDEXES" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… All Index Pages Present" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸ“ˆ Performance Metrics
      run: |
        echo "ğŸ“ˆ Performance metrics..."

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“ˆ Performance Metrics" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|---------|" >> $GITHUB_STEP_SUMMARY

        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ†æ
        LARGE_FILES=$(find _site -type f -size +1M | wc -l)
        if [ $LARGE_FILES -gt 0 ]; then
          echo "| Large Files (>1MB) | $LARGE_FILES | âš ï¸ Consider optimization |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Large Files (>1MB) | $LARGE_FILES | âœ… Good |" >> $GITHUB_STEP_SUMMARY
        fi

        # ç”»åƒæœ€é©åŒ–ãƒã‚§ãƒƒã‚¯
        IMAGES=$(find _site -name "*.jpg" -o -name "*.png" -o -name "*.gif" | wc -l)
        echo "| Images | $IMAGES | â„¹ï¸ Info |" >> $GITHUB_STEP_SUMMARY

        # CSS/JS ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
        CSS_FILES=$(find _site -name "*.css" | wc -l)
        JS_FILES=$(find _site -name "*.js" | wc -l)
        echo "| CSS Files | $CSS_FILES | â„¹ï¸ Info |" >> $GITHUB_STEP_SUMMARY
        echo "| JS Files | $JS_FILES | â„¹ï¸ Info |" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ”„ Cache Site Build
      uses: actions/cache@v3
      with:
        path: |
          _site
          .jekyll-cache
        key: ${{ runner.os }}-jekyll-${{ hashFiles('_config.yml', 'Gemfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-jekyll-

    - name: ğŸ“¤ Upload Site Artifact
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v3
      with:
        name: built-site
        path: _site/
        retention-days: 7

    - name: ğŸ’¬ Comment PR Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          // GITHUB_STEP_SUMMARY ã®å†…å®¹ã‚’èª­ã¿å–ã‚Š
          let summary = '# ğŸ”— Link Validation Results\n\n';
          summary += 'Link validation completed for this PR.\n\n';
          summary += '## ğŸ“Š Quick Summary\n';
          summary += '- âœ… Jekyll build: Success\n';
          summary += '- ğŸ” Internal links: Checked\n';
          summary += '- ğŸ“‹ Structure analysis: Complete\n\n';
          summary += 'For detailed results, check the [workflow run](' + context.payload.pull_request.html_url.replace('/pull/', '/actions/runs/') + ').\n';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    needs: link-validation

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ›¡ï¸ Security Advisory Check
      run: |
        echo "ğŸ›¡ï¸ Security advisory check..."

        # æ©Ÿå¯†æƒ…å ±ã®èª¤éœ²å‡ºãƒã‚§ãƒƒã‚¯
        if grep -r "password\|secret\|token\|key" _documents/ --include="*.md" | grep -v "# " | grep -v "example"; then
          echo "âš ï¸ Potential security issues found in documentation"
          exit 1
        else
          echo "âœ… No security issues found"
        fi

    - name: ğŸ” Link Security Analysis
      run: |
        echo "ğŸ” Link security analysis..."

        # HTTP ãƒªãƒ³ã‚¯ã®æ¤œå‡ºï¼ˆHTTPSæ¨å¥¨ï¼‰
        HTTP_LINKS=$(grep -r "http://" _documents/ --include="*.md" | grep -v "localhost" | wc -l)
        if [ $HTTP_LINKS -gt 0 ]; then
          echo "âš ï¸ Found $HTTP_LINKS HTTP links (HTTPS recommended)"
          grep -r "http://" _documents/ --include="*.md" | grep -v "localhost"
        else
          echo "âœ… All external links use HTTPS"
        fi
